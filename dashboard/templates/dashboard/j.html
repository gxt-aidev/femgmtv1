{% extends '../dashboard/base.html' %}

{% block title %}Edit Job - {{ job.job_id }} - FieldAI{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Edit Job: {{ job.job_id }}</h3>
    <div>
        <a href="{% url 'dashboard:job_detail' job.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Job Details
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="dashboard-card">
            <form method="POST">
                {% csrf_token %}
                
                {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Please correct the errors below:</strong>
                    <ul>
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Job Title *</label>
                        {{ form.title }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.service_type.id_for_label }}" class="form-label">Service Type *</label>
                        {{ form.service_type }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
                    {{ form.description }}
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.client.id_for_label }}" class="form-label">Client *</label>
                        {{ form.client }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.client_contact.id_for_label }}" class="form-label">Client Contact</label>
                        {{ form.client_contact }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.assigned_engineer.id_for_label }}" class="form-label">Assign Engineer</label>
                        {{ form.assigned_engineer }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.priority.id_for_label }}" class="form-label">Priority *</label>
                        {{ form.priority }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.scheduled_date.id_for_label }}" class="form-label">Scheduled Date & Time *</label>
                        {{ form.scheduled_date }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.estimated_duration.id_for_label }}" class="form-label">Estimated Duration (minutes) *</label>
                        {{ form.estimated_duration }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.location.id_for_label }}" class="form-label">Location *</label>
                    {{ form.location }}
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.latitude.id_for_label }}" class="form-label">Latitude</label>
                        {{ form.latitude }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.longitude.id_for_label }}" class="form-label">Longitude</label>
                        {{ form.longitude }}
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="{% url 'dashboard:job_detail' job.id %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="dashboard-card">
            <h5>Job Information</h5>
            <ul class="list-unstyled">
                <li class="mb-2"><strong>Job ID:</strong> {{ job.job_id }}</li>
                <li class="mb-2"><strong>Created:</strong> {{ job.created_at|date:"M d, Y H:i" }}</li>
                <li class="mb-2"><strong>Created By:</strong> {{ job.created_by.get_full_name }}</li>
                <li class="mb-2"><strong>Last Updated:</strong> {{ job.updated_at|date:"M d, Y H:i" }}</li>
                <li class="mb-2">
                    <strong>Current Status:</strong>
                    <span class="badge bg-{% if job.status == 'completed' %}success{% elif job.status == 'in_progress' %}warning{% elif job.status == 'cancelled' %}danger{% else %}info{% endif %}">
                        {{ job.get_status_display }}
                    </span>
                </li>
            </ul>
        </div>
        
        <div class="dashboard-card mt-4">
            <h5>Quick Actions</h5>
            <div class="d-grid gap-2">
                <a href="{% url 'dashboard:assign_engineer' job.id %}" class="btn btn-outline-primary text-start">
                    <i class="fas fa-user me-2"></i> Assign/Change Engineer
                </a>
                <a href="{% url 'dashboard:update_schedule' job.id %}" class="btn btn-outline-primary text-start">
                    <i class="fas fa-clock me-2"></i> Update Schedule
                </a>
                <button type="button" class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                    <i class="fas fa-sticky-note me-2"></i> Add Note
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel">Add Note to Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'dashboard:add_job_note_manager' job.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="note_type" class="form-label">Note Type</label>
                        <select class="form-select" id="note_type" name="note_type" required>
                            <option value="text">Text Note</option>
                            <option value="voice">Voice Note</option>
                            <option value="image">Image Note</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content</label>
                        <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Note</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Enhance form selects
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            select.classList.add('form-select');
        });
        
        // Enhance form inputs and textareas
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            if (!input.classList.contains('form-select')) {
                input.classList.add('form-control');
            }
        });
        
        // Format datetime field for better UX
        const scheduledDateInput = document.querySelector('input[type="datetime-local"]');
        if (scheduledDateInput && '{{ job.scheduled_date|date:"Y-m-d\TH:i" }}') {
            scheduledDateInput.value = '{{ job.scheduled_date|date:"Y-m-d\TH:i" }}';
        }
    });
</script>
{% endblock %}